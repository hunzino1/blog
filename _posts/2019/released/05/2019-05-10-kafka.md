---
layout:     post
title:      kafka教程2 - kafka存储结构
category: stack
tags: [stack]
excerpt: 一个人有多努力，就会有多幸运。
---

kafka概述
=======================================

本篇博文主要是对kafka文件存储系统进行介绍，通过本篇博文你将了解到：

* kafka的存储结构
* 面试点

-------------------------------------

1 kafka存储结构
---------------------------------

### 1.1 涉及概念

- topic 主题，特指kafka处理的消息源的不同分类
- partition topic物理上的分组，一个topic可以分为多个partition
- message 消息，是通信的基本单位

### 1.2 存储结构

#### 1.2.1 topic结构

- topic包含多个partition，
- topic只是逻辑概念，不涉及到存储，partition才是物理概念
- **同一topic的不同partition可能分布在不同机器上**

#### 1.2.2 partition结构

- partition是一个文件夹，其中包含多个segment
- 如果其中有n个segment，则共有 2 x n 个文件
- 每个partition是一个有序的队列
- partition中的每条消息都会分配一个有序的id，即offset

#### 1.2.3 segment结构

- 由一对文件组成，一个索引文件，一个数据文件
- 文件命名规则:
  - 上一个segment在partition中的最大offset数值，即，比如00000000000000345678.log文件中的第一条消息的offset为345679
  - 最大为64位的long，不足位数补0，如00000000000000345678.log
  - 索引文件后缀.index，日志数据文件后缀.log

##### 1.2.3.1 segment索引文件结构

- 存储一系列的元数据，每条元数据就是一条索引
- 元数据条数小于消息条数，是稀疏索引
- 元数据（即索引）构成
  - 索引所指向的message在数据日志文件中的相对序号，即相对的offset，从1开始，该相对offset加上文件名当中的值就是该message在整个partition中的绝对offset了
  - 索引所指向的message在数据日志文件中的位置，即文件游标，从0开始，方便直接指定游标打开数据文件

##### 1.2.3.2 segment日志数据文件结构

- 存储一系列的message

#### 1.2.4 message结构

- offset 偏移量，消息的唯一标识，通过offset能找到唯一消息，类型long 8bytes
- MessageSize 消息长度，类型int32 4bytes
- crc32校验码， 4bytes，校验message
- magic， 表示本次发布kafka服务程序协议版本号 1byte
- attributes 独立版本，标识压缩类型，编码类型 1byte
- key length 4bytes 当key length=-1时，key字段可不写
- key 可选
- payload 实际消息内容

**message特点**

- message是无状态的，即不会标识是否已被消费过
- message不能同时被多个consumer来消费，可以等前一个消费完成，下一个继续消费。
- consumer可以同时消费多条message

### 1.3 示例

#### 1.3.1 partition的结构

![partition](https://hunzino1.github.io/assets/images/2019/kafka/partition.png)
